
  <%# Layout the editor in a twelve-column grid. If we've got plenty
  of space, then labels take the left column. If space is tight, they
  take the two leftmost columns.  %>

  <% debug_figure_json = false %>


  <div class="container contra-dance-edit"  ng-app="contra">
<%= form_for(@dance) do |f| %>
  <% if @dance.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@dance.errors.count, "error") %> prohibited this dance from being saved:</h2>

      <ul>
      <% @dance.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

<% if params[:copy_dance_id] then
     copy_dance = Dance.find(params[:copy_dance_id])
   else
     copy_dance = nil
   end 
%>

  <% if copy_dance then %>
  <div class="row">
    <div class="col-lg-1 col-md-2 col-xs-3"></div>
    <div class="col-lg-11 col-md-10 col-xs-9">Composing a variation of <strong><%= copy_dance.title %></strong></div>
  </div>
  <% end %>


  <div class="row field">
    <%= f.label "Title", class: "contra-label col-lg-1 col-md-2 col-xs-3" %>
    <%= if copy_dance 
        then f.text_field :title, {class: "dance-title-edit col-lg-11 col-md-10 col-xs-9", value: copy_dance.title + ' variation'}
        else f.text_field :title, {class: "dance-title-edit col-lg-11 col-md-10 col-xs-9"}
        end %>
  </div>
  <div class="row field">
    <%= f.label "by", class: "col-lg-1 col-md-2 col-xs-3" %>
    <%= props = {class: "col-lg-11 col-md-10 col-xs-9", id: "choreographer-autocomplete"}
        props[:value] = copy_dance.choreographer.name if copy_dance
        f.text_field :choreographer_name, props %>
    <script>
      $( "#choreographer-autocomplete" ).autocomplete({
        source: <%= a_to_safe_str(Choreographer.all.map &:name) %>,
        autoFocus: true,
        minLength: 0
      });
    </script>
  </div>
  <div class="row field">
    <%= f.label :formation, class: "col-lg-1 col-md-2 col-xs-3" %>
    <%= f.text_field :start_type, {class: "col-lg-11 col-md-10 col-xs-9", id: "start-type-autocomplete"}.merge(copy_dance ? {value: copy_dance.start_type} : {}) %>
    <script>
      $( "#start-type-autocomplete" ).autocomplete({
        source: ["improper","Becket","four face four","square dance","indecent"],
        autoFocus: true,
        minLength: 0
      });
    </script>
  </div>



<%# ============================ new figure editors ==================== %>



<%# ======================================================================== %>

  <div ng-controller="FiguresController as figures">
    <!-- Add/delete figure buttons -->
    <div class="row actions">
      <%= f.label :figures, class: "col-lg-1 col-md-2 col-xs-3" %>
      <div class="col-lg-11 col-md-10 col-xs-9">
        <div class="btn-group btn-group-justified btn-group-lg" role="group">
          <div class="btn-group">
            <button name="button" type="button" ng-click='addFigure()' class="btn btn-default"><%= plus_icon_html() %> Add Figure</button>
          </div>
          <div class="btn-group">
            <button name="button" type="button" ng-click='deleteFigure()' ng-show="figures.arr.length > 0" class="btn btn-default"><%= x_icon_html() %> Remove Figure</button>
          </div>
        </div>
      </div>
    </div>


    <div class="row">
      <table class="figure_edits col-lg-12 col-xs-12">
        <thead ng-init="figures.arr=defaultFigures(<%= 
                        if copy_dance 
                        then copy_dance.figures_json 
                        else @dance.figures_json 
                        end %>)">
          <tr>                                       <!-- 12 twelfths -->
            <th style="width:  8.33333%"></th>       <!-- 1 -->
            <th style="width: 16.66667%">formation</th><!-- 2 -->
            <th style="width: 16.66667%">who</th>     <!-- 2. -->
            <th style="width:  2.77778%">B+</th>      <!-- 0.333 -->
            <th style="width: 13.33333%">move</th>    <!-- 1.667 -->
            <th style="width:  8.33333%">beats</th>   <!-- 1 -->
            <th style="width: 16.66667%">turn</th>    <!-- 2 -->
            <th style="width: 16.66667%">notes</th>    <!-- 2 -->
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="figure in figures.arr"
              class="figure_edit"
              ng-class="styleForBeats(sumBeats(figures.arr,$index))">
            <td style="text-align: center">{{labelForBeats(sumBeats(figures.arr,$index))}}</td>
            <td><select class="formation_edit" ng-model="figure.formation">
                <option value="">...</option>
                <option value="square">square</option>
                <option value="short_lines">short lines</option>
                <option value="short_wavy_lines">short wavy lines</option>
                <option value="long_wavy_lines">long wavy lines</option>
                <option value="long_wavy_line">long wavy line</option>
                <option value="custom">custom</option>
              </select>
            </td>

            <td><select class="who_edit" ng-model="figure.who">
                <option value="everybody">everybody</option>
                <option value="partner">partner</option>
                <option value="neighbor">neighbor</option>
                <option value="ladles">ladles</option>
                <option value="gentlespoons">gentlespoons</option>
                <option value="ones">ones</option>
                <option value="twos">twos</option>
                <option value="centers">centers</option>
                <option value="custom">custom</option>
              </select>
            </td>
            <td><input type="checkbox" class="balance_edit" ng-disabled="!moveCaresAboutBalance(figure.move)" ng-model="figure.balance"/></td>
            <td><select class="move_edit" ng-model="figure.move"
                        ng-options="m for m in moveMenuOptions(figure.formation, figure.who)"
                        ng-change="figure.balance = figure.balance && moveCaresAboutBalance(figure.move)">
              </select>
            </td>
            <td><select class="beat_edit" ng-model="figure.beats" ng-options="b for b in [8,16,0,1,2,3,4,6,8,10,12,14,16,20,24,32,48,64]">
              </select>
            </td>

            <td><select class="turns_edit" ng-model="figure.degrees"
                        ng-show="moveCaresAboutRotations(figure.move)||moveCaresAboutPlaces(figure.move)"
                        ng-options="degreesToHumanUnits(a,figure.move) for a in anglesForMove(figure.move)"
                        >
                
              </select>
            </td>
            <td><input class="notes_edit" type="text" ng-model="figure.notes"/></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th ng-class="64==sumBeats(figures.arr)?'happy_beats':'grumpy_beats'">
              {{sumBeats(figures.arr)}}</th>
            <th></th>
            <th></th>
          </tr>
        </tfoot>
   
      </table>
    </div>

    

  <!-- debugger -->
  <% if debug_figure_json then  %>
  <div class="row">
    <div class="col-lg-1 col-md-2 col-xs-3" style="text-align: center">#</div>
    <div class="col-lg-11 col-md-10 col-xs-9"><strong style="color: red">debug_figure_json = true </strong></div>
  </div>
  <div class="row" ng-repeat="figure in figures.arr">
    <div class="col-lg-1 col-md-2 col-xs-3" style="text-align: center">{{$index}}</div>
    <div class="col-lg-11 col-md-10 col-xs-9">{{figure}}</div>
  </div>
  <% end %> 



  <!-- hidden IO field for communicating with Rails -->
  <div class="row field" <%= debug_figure_json ?  '' : 'hidden="hidden"' %> >
    <%= f.label :figures_json, class: "col-lg-1 col-md-2 col-xs-3"%>
  <%= begin
      h0 = {class: "figures_json col-lg-11 col-md-10 col-xs-9", 
            value: "{{toJson(figures.arr)}}" ,
            readonly: "readonly"}
      f.text_area "figures_json", h0
      end %>
  </div>
  </div> <!-- figures controller -->








<%# ============================ end new figure editors ================ %>






  <div class="row field">
    <%= f.label :notes, class: "col-lg-1 col-md-2 col-xs-3"%>

    <%= begin
          h = {class: 'per_dance_notes_edit col-lg-11 col-md-10 col-xs-9'};
          if copy_dance then
            h[:value] = copy_dance.notes
          end
          f.text_area :notes, h
        end  %>
  </div>
  <br>

  <div class="row actions">
    <div class="col-lg-1 col-md-2 col-xs-3"></div>
    <%= save_submit_button_html "Save Dance", {class: "update_dance col-lg-3 col-md-10 col-xs-9"} %>
  </div>

  <div class="row actions">
    <div class="col-lg-1 col-md-2 col-xs-3"></div>
    <p class="col-lg-3 col-md-10 col-xs-9">You may use <a href="https://daringfireball.net/projects/markdown/basics">Markdown</a> in your notes. </p>
  </div>

<% end %>



</div>
